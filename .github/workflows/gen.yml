name: "Generate"
on:
  workflow_dispatch:
  workflow_run:
    workflows: [Collate changed files]
    branches: [test-checks-trigger, test-checks-trigger2, 3.*, 4.*, main]
#    types: [requested,completed] #

permissions:
  contents: write

jobs:
  debug:
    runs-on: ubuntu-latest
    steps:
      - name: Debug
        env:
          GITHUB_CONTEXT: ${{ toJson(github) }}
        run: |
          echo "$GITHUB_CONTEXT"

  generate:
    runs-on: ubuntu-latest
    #runs-on: [self-hosted, linux, arm64, aws, xxlarge]
    #if: github.event.pull_request.draft == false #&& needs.jobs.should-run.outputs.check-generate == true
    # if: ${{ github.event.workflow_run.conclusion == 'success' }}
    outputs:
      check-generate: ${{ fromJSON(steps.return-parsed-json.outputs.result).check-generate }}
    steps:
      - name: Download flags
        uses: actions/download-artifact@v4
        with:
#          name: check-flags
#          path: ./
          github-token: ${{ github.token }}
          #github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}
      - name: List Files
        run: |
          ls -R
          echo "run id ${{ github.event.workflow_run.id }}"
          echo "generate flag is "${{ needs.jobs.should-run.outputs.check-generate }}""
      - name: Read flags flags
        uses: actions/github-script@v6
        id: return-parsed-json
        with:
          script: |
            let fs = require('fs');
            let data = fs.readFileSync('./check-flags.json');
            return JSON.parse(data);
      - name: "Print flags"
        run: |
          echo "flags: fromJSON(steps.return-parsed-json.outputs.result)"
####
      - name: "Checkout"
        uses: actions/checkout@v4

      - name: "Set up Go"
        if: steps.should-run.outputs.go == 'true'
        uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'
          cache: true

      - name: "Delete all mocks"
        if: steps.should-run.outputs.go == 'true'
        shell: bash
        # Ideally we'd delete all generated files, but we can't because some of
        # the Go code depends on generated files for go:generate to actually work.
        run: |
          for FILE in $(grep '// Code generated by MockGen. DO NOT EDIT.' -r . -l --include \*.go); do
            rm $FILE
          done

      - name: "Regenerate code"
        shell: bash
        run: |
          # Running go generate by itself is slow over a large codebase, where
          # all generate directives are dispersed over many files. Instead, the
          # following uses tools for locating and extracting the directives,
          # before piping them to go generate in parallel.
          #
          #  1. grep for go generate directive in the go files recursively.
          #  2. Grab the file name of each select file.
          #  3. Unique every file, so we only go generate the file once.
          #  4. Using xargs perform go generate in parallel.
          #
          grep -ir "//go:generate" --include '*.go' . | awk -F : '{ print $1 }' | uniq | xargs -n 1 -P 8 -I% go generate -x $(realpath %)

      - name: "Check diff"
        shell: bash
        run: |
          git add -A
          if [[ -n $(git diff HEAD) ]]; then
            # Print the full diff for debugging purposes
            git diff HEAD
            echo "*****"
            echo "The following generated files have been modified:"
            git diff --name-status HEAD
            echo "Please regenerate these files and check in the changes."
            echo "*****"
            exit 1
          fi
